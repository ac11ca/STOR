<?php

namespace AppBundle\Repository;
use Doctrine\Common\Collections\ArrayCollection;
use AppBundle\Entity\Product;
use AppBundle\Factory\ReviewFactory;
/**
 * ReviewRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ReviewRepository extends ApplicationMasterRepository
{
    protected $filter_property = 'rating';
    protected $FactoryType = 'AppBundle\Factory\ReviewFactory';

    public function getFactory($Doctrine, $Container)
    {
        $Manager = $Container->get('app.user_manager');
        $CryptographyService = $Container->get('app.cryptography');
        return new ReviewFactory($this, $Doctrine,$Manager);
    }
    
    public function prepareFilterByParent($query, $parentid)
    {
        $query->innerJoin('e.Product', 'p');
        $query->andWhere('p.id = :product_id');
        $query->setParameter(':product_id',$parentid);
        return $query;
    }

    public function customQueryExtension($query, $filter = null)
    {
        if(!empty($filter))
        {
            $query->orWhere('FLOOR(e.rating) = :filter');
        }

        return $query;
    }

    public function findByProductAverages($products)
    {       
        $formatted_result = [];
		if(is_a($products, 'Doctrine\Common\Collections\ArrayCollection'))
	        $product_collection = $products; 
		else
			$product_collection = new ArrayCollection($products);

        $query = $this->createQueryBuilder('r')
                    ->select('AVG(r.rating), count(r.rating), p.id')
                    ->innerJoin('r.Product','p')
                    ->where('r.Product in (:products)')
                    ->groupBy('r.Product')
                    ->setParameter(':products',$product_collection);
        $result = $query->getQuery()->getResult();            

        for($i = 0; $i < count($result); $i++)
        {
            $formatted_result[$result[$i]['id']] = ['rating' => $result[$i][1], 'count'=>$result[$i][2]];
        }        

        return $formatted_result;
    }

    public function findByProductAndValue(Product $Product)
    {
        $rating_sums = [];
        $ratings = [];
        $total = 0;
        $query = $this->createQueryBuilder('r')
                   ->select('r.rating')
                   ->where('r.Product = :product')
                   ->setParameter(':product',$Product);
        $result = $query->getQuery()->getResult();       
        for($i = 0; $i < count($result); $i++)
        {
           if(empty($rating_sums[floor($result[$i]['rating'])]))
               $rating_sums[floor($result[$i]['rating'])] = 0;

           $rating_sums[floor($result[$i]['rating'])]++;
           $total++;
        }

        foreach($rating_sums as $rating=>$tally)
        {
            $ratings[$rating] = [
                'total' => $tally
                ,'percent' => ($total > 0 ? ($tally / $total) : 0)
            ];
        }

        return $ratings;
    }
}
